global
    log stdout format raw local0 info
    maxconn 4096
    daemon

defaults
    log global
    mode tcp
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    timeout check 5s
    option tcp-check
    balance roundrobin

# =============================================================================
# PostgreSQL-compatible load balancer
# =============================================================================
frontend aurora_postgres
    bind *:5432
    default_backend aurora_postgres_backends

backend aurora_postgres_backends
    option tcp-check
    tcp-check connect
    tcp-check send PING\r\n
    tcp-check expect string PONG

    # Primary node (read-write)
    server aurora-primary aurora-primary:5432 check inter 5s rise 2 fall 3 weight 100

    # Replica nodes (read-only)
    server aurora-replica aurora-replica:5432 check inter 5s rise 2 fall 3 weight 50

# =============================================================================
# HTTP API load balancer
# =============================================================================
frontend aurora_http
    bind *:8080
    mode http
    option httplog
    default_backend aurora_http_backends

    # Health check endpoint
    acl health_check path /health
    use_backend aurora_health if health_check

backend aurora_http_backends
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # Primary node
    server aurora-primary aurora-primary:8080 check inter 5s rise 2 fall 3

    # Replica nodes
    server aurora-replica aurora-replica:8080 check inter 5s rise 2 fall 3

backend aurora_health
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    server aurora-primary aurora-primary:8080 check inter 5s rise 2 fall 3
    server aurora-replica aurora-replica:8080 check inter 5s rise 2 fall 3

# =============================================================================
# Statistics and monitoring
# =============================================================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# =============================================================================
# PostgreSQL-specific configuration
# =============================================================================
# Handle PostgreSQL startup messages and SSL requests
frontend aurora_postgres_ssl
    bind *:5432 ssl crt /etc/ssl/certs/aurora.pem
    mode tcp
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # SSL termination for PostgreSQL
    acl is_ssl req.ssl_ver gt 0
    use_backend aurora_postgres_ssl_backends if is_ssl

backend aurora_postgres_ssl_backends
    mode tcp
    option ssl-hello-chk

    server aurora-primary aurora-primary:5432 check ssl verify none
    server aurora-replica aurora-replica:5432 check ssl verify none

# =============================================================================
# Connection limits and security
# =============================================================================
# Rate limiting
frontend aurora_rate_limit
    bind *:5432
    stick-table type ip size 100k expire 30s store conn_rate(10s)
    tcp-request content track-sc1 src
    tcp-request content reject if { sc1_conn_rate gt 100 }

# SSL/TLS configuration
global
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2
